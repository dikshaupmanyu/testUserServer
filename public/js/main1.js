var config = {
    apiKey: "AIzaSyA0o46jRmw6OghL2fcpdIcNWDeG1EQ5upQ",
    authDomain: "tradetips-9baa3.firebaseapp.com",
    databaseURL: "https://tradetips-9baa3.firebaseio.com",
    projectId: "tradetips-9baa3",
    type: "service_account",
    project_id: "tradetips-9baa3",
    storageBucket: "tradetips-9baa3.appspot.com",
    messagingSenderId: "592114858590",
    appId: "1:592114858590:web:2e2f77237953b570fb52cf",
    measurementId: "G-B3RPK4JXG3",
    private_key_id: "9efaa0e3e7bf1fac231c69b552514e210442b223",
    private_key: "-----BEGIN PRIVATE KEY-----\nMIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQDoxICupYmqJ8yY\nmWkKk8lWp3dKzdAfOkAuyb8yrD9WWYOSUsAMIBY+irMBy74uFeJry8hfHicsBWSW\nuzL04S2S6dlJfeuBFI7GmgNIUG3GDfBROKeUS/XUzY2qg0+dNvgYgFbzoBNc0sMH\nxf4Ezarp/3CDqroWQRD0hvn2zUjNOnWqMP4NcZZfhyNJJcrFyvEWcMs8gWR0r+fQ\nijbGVgqf1n9T+HpGBXkXi9X3tZHe3HW4P6n0gjLU1eU8kOr6V6LDDAngp6ESsuQJ\nAyN81Sz9Axi4hygyWl7Oq7zpitVQxjHwzdMuWMGb/GbnHsleJRYHErk85qaHAvp1\nuS416baJAgMBAAECggEACe+VZJ8ZVMOVJrBpvPNZBVNpsq49Y4/bfIPNHw8eNwPk\nK2NP4lSeTnYiNQHq8NGrVBmjSHgjiOwEArEj+DMCfIJx7YKsAlsLyyt412XjgbBH\noVfvQ1PIvxg1I2GujNHzXixgSc779Jrki1jmwnK7CHkIZv5rKhcF78IxOllB8cyn\nsDdEOkYPAvYeVpIG1j3JQD4Yeo5xyT/MEhzZKqvNeg+uKkDS9R3P5jz94gRTbAtv\n3sKuS6Hrx2tn+BmqhpG1YFlKGMeTpAN42Jf96HJZQQvzho1AmTJh1Ep3fCgMOYhW\n0IJa1JnfVlHlZrL2NmLJ7ac+7yCIBPCXGtkihaHmzwKBgQD4g3si7vB2PBFTXxX5\nTJ0LubY/zyMp0sja/Rp2JYVVHh2WNHa6/TKyxksCG2OlMHbHV99QTrBuIyVYPWbN\njGPeQQAwd+y31RhHyePG99gwxvY8rRSzrEoPev6/6LHM5MdPqNzyujY0w0kUp5UR\nUyANKnCVeOll4IEmApBNfT3UhwKBgQDvx5buPbqdGA4mPKmEq/TLUy4OXVCnd1e3\nOe95qQIcbChCCAkSVeJ3nSvE5d0eBGJNlhaWeTA3DP/963o4frkRmaQJK9BsXdnb\nVj5iG3QRRKCYpamH1kY1AHc/G7P7a4hBPJ+4yblpGBiC7EayG9uBhgDA2sdLOPWW\nF1pZ20TwbwKBgAjz66a5hu4rgdBIF6mQigPXH+qykqi6EERbY+2nsmL7n8M+hpx7\n7KymGiOsSu2zjkPmNYRWIWMGXx0LsT1sdliWbORSHbQNuD811b/gQ+iV8l8DOUCz\nz0M5gh31yxn/j/KducAA110VP/e/hc5G+VugEMhBv97MtLpi00IHZgfXAoGBAIBq\nmWfQwY/+4R0TYgp++aSnUMQ6r8ZwwRaNPbcfj9TfDBSJLyqVuqsrDtTt8qVv3aIF\n3uUJ1Iu3N6arJZL6M228pkCPKZnQDaxNnS133IqfAY+fMZNha8pZDIRM9vCRH7Eo\nobYau2UQlZgQqLAdAUt2FBM1WITt5YFT0nzLVTmbAoGBAO/p5zqkeQ3Yjt7qIs8g\nbQTByK/9TsDRdiK9RfsEKuq70BHLuyYoW6jt9yR4AlbQHEFjGek9mWw4k45aZB5P\n2vjISHPiQoAAGVE9eowmvcckYn+IFFkNIs9s3UBX1d2RBzOgy3XMYE897DWGmKc+\n7F3mTXJtUyyjUqERXKBTYxN0\n-----END PRIVATE KEY-----\n",
    client_email: "firebase-adminsdk-olv1b@tradetips-9baa3.iam.gserviceaccount.com",
    client_id: "112955508654296836542",
    auth_uri: "https://accounts.google.com/o/oauth2/auth",
    token_uri: "https://oauth2.googleapis.com/token",
    auth_provider_x509_cert_url: "https://www.googleapis.com/oauth2/v1/certs",
    client_x509_cert_url: "https://www.googleapis.com/robot/v1/metadata/x509/firebase-adminsdk-zgd2j%40chatdemo-96e4f.iam.gserviceaccount.com"
    // apiKey: "AIzaSyA89MvmT1QzbvnCGfZ8B7yaJRuE3DwaOPE",
    // authDomain: "chatdemo-96e4f.firebaseapp.com",
    // databaseURL: "https://chatdemo-96e4f.firebaseio.com",
    // projectId: "chatdemo-96e4f",
    // type: "service_account",
    // project_id: "chatdemo-96e4f",
    // storageBucket: "chatdemo-96e4f.appspot.com",
    // messagingSenderId: "993956240122",
    // appId: "1:993956240122:web:cb9941a3090a8d029cc743",
    // private_key_id: "9efaa0e3e7bf1fac231c69b552514e210442b223",
    // private_key: "-----BEGIN PRIVATE KEY-----\nMIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQDoxICupYmqJ8yY\nmWkKk8lWp3dKzdAfOkAuyb8yrD9WWYOSUsAMIBY+irMBy74uFeJry8hfHicsBWSW\nuzL04S2S6dlJfeuBFI7GmgNIUG3GDfBROKeUS/XUzY2qg0+dNvgYgFbzoBNc0sMH\nxf4Ezarp/3CDqroWQRD0hvn2zUjNOnWqMP4NcZZfhyNJJcrFyvEWcMs8gWR0r+fQ\nijbGVgqf1n9T+HpGBXkXi9X3tZHe3HW4P6n0gjLU1eU8kOr6V6LDDAngp6ESsuQJ\nAyN81Sz9Axi4hygyWl7Oq7zpitVQxjHwzdMuWMGb/GbnHsleJRYHErk85qaHAvp1\nuS416baJAgMBAAECggEACe+VZJ8ZVMOVJrBpvPNZBVNpsq49Y4/bfIPNHw8eNwPk\nK2NP4lSeTnYiNQHq8NGrVBmjSHgjiOwEArEj+DMCfIJx7YKsAlsLyyt412XjgbBH\noVfvQ1PIvxg1I2GujNHzXixgSc779Jrki1jmwnK7CHkIZv5rKhcF78IxOllB8cyn\nsDdEOkYPAvYeVpIG1j3JQD4Yeo5xyT/MEhzZKqvNeg+uKkDS9R3P5jz94gRTbAtv\n3sKuS6Hrx2tn+BmqhpG1YFlKGMeTpAN42Jf96HJZQQvzho1AmTJh1Ep3fCgMOYhW\n0IJa1JnfVlHlZrL2NmLJ7ac+7yCIBPCXGtkihaHmzwKBgQD4g3si7vB2PBFTXxX5\nTJ0LubY/zyMp0sja/Rp2JYVVHh2WNHa6/TKyxksCG2OlMHbHV99QTrBuIyVYPWbN\njGPeQQAwd+y31RhHyePG99gwxvY8rRSzrEoPev6/6LHM5MdPqNzyujY0w0kUp5UR\nUyANKnCVeOll4IEmApBNfT3UhwKBgQDvx5buPbqdGA4mPKmEq/TLUy4OXVCnd1e3\nOe95qQIcbChCCAkSVeJ3nSvE5d0eBGJNlhaWeTA3DP/963o4frkRmaQJK9BsXdnb\nVj5iG3QRRKCYpamH1kY1AHc/G7P7a4hBPJ+4yblpGBiC7EayG9uBhgDA2sdLOPWW\nF1pZ20TwbwKBgAjz66a5hu4rgdBIF6mQigPXH+qykqi6EERbY+2nsmL7n8M+hpx7\n7KymGiOsSu2zjkPmNYRWIWMGXx0LsT1sdliWbORSHbQNuD811b/gQ+iV8l8DOUCz\nz0M5gh31yxn/j/KducAA110VP/e/hc5G+VugEMhBv97MtLpi00IHZgfXAoGBAIBq\nmWfQwY/+4R0TYgp++aSnUMQ6r8ZwwRaNPbcfj9TfDBSJLyqVuqsrDtTt8qVv3aIF\n3uUJ1Iu3N6arJZL6M228pkCPKZnQDaxNnS133IqfAY+fMZNha8pZDIRM9vCRH7Eo\nobYau2UQlZgQqLAdAUt2FBM1WITt5YFT0nzLVTmbAoGBAO/p5zqkeQ3Yjt7qIs8g\nbQTByK/9TsDRdiK9RfsEKuq70BHLuyYoW6jt9yR4AlbQHEFjGek9mWw4k45aZB5P\n2vjISHPiQoAAGVE9eowmvcckYn+IFFkNIs9s3UBX1d2RBzOgy3XMYE897DWGmKc+\n7F3mTXJtUyyjUqERXKBTYxN0\n-----END PRIVATE KEY-----\n",
    // client_email: "firebase-adminsdk-zgd2j@chatdemo-96e4f.iam.gserviceaccount.com",
    // client_id: "112955508654296836542",
    // auth_uri: "https://accounts.google.com/o/oauth2/auth",
    // token_uri: "https://oauth2.googleapis.com/token",
    // auth_provider_x509_cert_url: "https://www.googleapis.com/oauth2/v1/certs",
    // client_x509_cert_url: "https://www.googleapis.com/robot/v1/metadata/x509/firebase-adminsdk-zgd2j%40chatdemo-96e4f.iam.gserviceaccount.com"

};

firebase.initializeApp(config);

var db = firebase.firestore();
// alert(db);

// var sData = localStorage.getItem('allTokenData');
// var storageData= JSON.parse(sData);
// var loggedInVal = storageData.uid;
// alert(loggedInVal);
       
const docRef = db.collection("/openGroups/demoOpenGroup1/messages/");
const tasksDOM = document.getElementById("tasks");
var fullName   = document.getElementById('user_nickname');
var message    = document.getElementById('btn-input');
var userId     = document.getElementById('user_id');
// var hiddenId   = document.getElementById('hiddenId');
var date = document.getElementById('dateval');
// utility functions
function cleanData(snapshots) {
  let data = [];
  snapshots.forEach(function (doc) {
    data.push({ id: doc.id, ...doc.data() });
  });
  return data;
}

// form functions
function handleCreate(event) {
  event.preventDefault();
   // alert(JSON.stringify(event));

  var sData = localStorage.getItem('allTokenData');
  var storageData= JSON.parse(sData);
  var loggedInVal = storageData.uid;
  // alert(loggedInVal);
  var loggedInName = storageData.uname;
  // alert(loggedInName);
  // var today = Date.now();
  // var str = today.toDateString().split(' ').slice(1).join(' ') + " at " + today.toLocaleTimeString() + " GMT+5:30";
       
   if(message.value != ""){

    let task = {
    userName: loggedInName,
    userId : loggedInVal,
    message: message.value,
    messageId : loggedInVal + "_"+  Date.now(),
    messageType : "text",
    createdDate :  Date.now(),
    profileImageUrl : "https://apis.tradetipsapp.com/api/appUser/getImageByAppUserId?appUserId="+loggedInVal,
    messageSource : "Web"
    // status: "incomplete"
  };
  return docRef
    .add(task)
    .then((ref) => {
      task.id = ref.id;
      fullName.value = '';
      message.value  = '';
      // date.value = '';
      // return createTask(task);
    });

   }else{
    alert("Message not empty");
   }    
 
}

// function handleStatusUpdate(task) {
//   //
// }

$('i.fa.fa-paperclip.attachment.btn.btn-primary').click(function () {
  // alert("calll");
  $("input[type='file']").trigger('click');
  // alert("data");
});

$("input[type='file']").on('change', function(e) {
   // alert("hii");
  var val = $(this).val();
  // alert(val);
  // $(this).siblings('span').text(val);
  // $('#btn-input').text(val);

  $(this).siblings('input#btn-input').text(val);

  const file = e.target.files[0];
  console.log(file);
  console.log(file.type);

  var sData = localStorage.getItem('allTokenData');
  var storageData= JSON.parse(sData);
  var loggedInVal = storageData.uid;
  // alert(loggedInVal);
  var loggedInName = storageData.uname;
  // alert(loggedInName);
  // var today = Date.now();
  // var str = today.toDateString().split(' ').slice(1).join(' ') + " at " + today.toLocaleTimeString() + " GMT+5:30";

  if(file.type == "video/mp4"){

    firebase.storage().ref('message_videos/').child("photo_message_"+loggedInVal+"_"+"_"+Date.now()).put(file).then(function(snapshot) {
      return snapshot.ref.getDownloadURL()
   }).then(url => {
     console.log("Firebase storage image uploaded : ", url); 
       
       
  let task = {
    userName: loggedInName,
    userId : loggedInVal,
    message: url,
    messageId : loggedInVal + "_"+ Date.now(),
    messageType : "video",
    createdDate : Date.now(),
    profileImageUrl : "https://apis.tradetipsapp.com/api/appUser/getImageByAppUserId?appUserId="+loggedInVal,
    // status: "incomplete"
    messageSource : "Web"
  };
  return docRef
    .add(task)
    .then((ref) => {
      console.log(ref.id);
      task.id = ref.id;
      fullName.value = '';
      message.value  = '';
      // date.value = '';
      // return createTask(task);
    });


    }); 

  }else if(file.type == "audio/mpeg"){

    firebase.storage().ref('message_audios/').child("photo_message_"+loggedInVal+"_"+"_"+Date.now()).put(file).then(function(snapshot) {
      return snapshot.ref.getDownloadURL()
   }).then(url => {
     console.log("Firebase storage image uploaded : ", url); 
       
       
  let task = {
    userName: loggedInName,
    userId : loggedInVal,
    message: url,
    messageId : loggedInVal + "_"+ Date.now(),
    messageType : "audio",
    createdDate : Date.now(),
    profileImageUrl : "https://apis.tradetipsapp.com/api/appUser/getImageByAppUserId?appUserId="+loggedInVal,
    // status: "incomplete"
    messageSource : "Web"
  };
  return docRef
    .add(task)
    .then((ref) => {
      console.log(ref.id);
      task.id = ref.id;
      fullName.value = '';
      message.value  = '';
      // date.value = '';
      // return createTask(task);
    });


    }); 

  } else {


    firebase.storage().ref('message_images/').child("photo_message_"+loggedInVal+"_"+"_"+Date.now()).put(file).then(function(snapshot) {
      return snapshot.ref.getDownloadURL()
   }).then(url => {
     console.log("Firebase storage image uploaded : ", url); 
       
       
  let task = {
    userName: loggedInName,
    userId : loggedInVal,
    message: url,
    messageId : loggedInVal + "_"+ Date.now(),
    messageType : "photo",
    createdDate : Date.now(),
    profileImageUrl : "https://apis.tradetipsapp.com/api/appUser/getImageByAppUserId?appUserId="+loggedInVal,
    // status: "incomplete"
    messageSource : "Web"
  };
  return docRef
    .add(task)
    .then((ref) => {
      console.log(ref.id);
      task.id = ref.id;
      fullName.value = '';
      message.value  = '';
      // date.value = '';
      // return createTask(task);
    });


    }); 

  }
// return firebase
//     .app()
//     .storage()
//     .ref('message_images')
//     .child(file.name)
//     .put(file)
//     // .then(snapshot => {
//     //   // snapshot represents the uploaded file
//     //   console.log(snapshot);
//     // })
//     .getDownloadURL()
//     .then(imgUrl => {
//       console.log(imgUrl);
//     });

// var remoteimageurl = e.target.files[0]
// var filename = file.name

// fetch(remoteimageurl).then(res => {
//   return res.blob();
// }).then(blob => {
//     //uploading blob to firebase storage
//   firebase.storage().ref('message_images/').child(filename).put(blob).then(function(snapshot) {
//     return snapshot.ref.getDownloadURL()
//  }).then(url => {
//    console.log("Firebase storage image uploaded : ", url); 
//   }) 
// }).catch(error => {
//   console.error(error);
// });


  
});

function handleDelete(id) {
  return docRef
    .doc(id)
    .delete()
    .then(() => document.getElementById(id).remove());
}

// dom functions
function createTask(task) {
  // alert(task);
  var sData = localStorage.getItem('allTokenData');
  var storageData= JSON.parse(sData);
  var loggedInVal = storageData.uid;
   var loggedInName = storageData.uname;
  // alert(loggedInName)
  const elem = document.createElement("li");
  // elem.id = task.id;
  // elem.innerHTML = reviewTemplate(task)
  elem.setAttribute("id", task.id);
  // elem.setAttribute("class", "admin clearfix");
  let taskElem;

  // alert(task.createdDate);

  if (task.userId === loggedInVal) {

    // taskElem = document.createElement("li");
    elem.setAttribute("class", "admin clearfix");

      if(task.messageType === "photo"){

        elem.innerHTML = '<span class="chat-img right clearfix mx-2"><img src="'+ task.profileImageUrl +'" alt="Admin" class="img-circle" style="width: 100%;"/></span><div class="chat-body clearfix"><div class="header clearfix"><small class="left text-muted"><span class="glyphicon glyphicon-time"></span>' + task.createdDate + '</small><strong class="right primary-font" class="fullName">'+ task.userName +'</strong></div><p class="message"><img src="'+ task.message +'" class="img-responsive" style="width:100%;"/></p></div>'


      } else if(task.messageType === "audio"){

        elem.innerHTML = '<span class="chat-img right clearfix mx-2"><img src="'+ task.profileImageUrl +'" alt="Admin" class="img-circle" style="width: 100%;"/></span><div class="chat-body clearfix"><div class="header clearfix"><small class="left text-muted"><span class="glyphicon glyphicon-time"></span>' + task.createdDate + '</small><strong class="right primary-font" class="fullName">'+ task.userName +'</strong></div><audio controls><source src="' + task.message +'" type="audio/mpeg"></audio></div>'

      } else if(task.messageType === "video"){

        elem.innerHTML = '<span class="chat-img right clearfix mx-2"><img src="'+ task.profileImageUrl +'" alt="Admin" class="img-circle" style="width: 100%;"/></span><div class="chat-body clearfix"><div class="header clearfix"><small class="left text-muted"><span class="glyphicon glyphicon-time"></span>' + task.createdDate + '</small><strong class="right primary-font" class="fullName">'+ task.userName +'</strong></div><video controls style="width:100%;"><source src="' + task.message +'" type="video/mp4"></video></div>'

      } else {

        elem.innerHTML = '<span class="chat-img right clearfix mx-2"><img src="'+ task.profileImageUrl +'" alt="Admin" class="img-circle" style="width: 100%;"/></span><div class="chat-body clearfix"><div class="header clearfix"><small class="left text-muted"><span class="glyphicon glyphicon-time"></span>' + task.createdDate + '</small><strong class="right primary-font" class="fullName">'+ task.userName +'</strong></div><p class="message">' + task.message +'</p></div>'

      }

  } else {
    // taskElem = document.createElement("li");
    elem.setAttribute("class", "agent clearfix");

      if(task.messageType === "photo"){

          elem.innerHTML = '<span class="chat-img left clearfix mx-2"><img src="'+ task.profileImageUrl +'" alt="Admin" class="img-circle" style="width: 100%;"/></span><div class="chat-body clearfix"><div class="header clearfix"><small class="right text-muted"><span class="glyphicon glyphicon-time"></span>' + task.createdDate + '</small><strong class="primary-font" class="fullName">'+ task.userName +'</strong></div><p class="message"><img src="'+ task.message +'" class="img-responsive" style="width:100%;"/></p></div>'


      } else if(task.messageType === "audio"){

         elem.innerHTML = '<span class="chat-img left clearfix mx-2"><img src="'+ task.profileImageUrl +'" alt="Admin" class="img-circle" style="width: 100%;"/></span><div class="chat-body clearfix"><div class="header clearfix"><small class="right text-muted"><span class="glyphicon glyphicon-time"></span>' + task.createdDate + '</small><strong class="primary-font" class="fullName">'+ task.userName +'</strong></div><audio controls><source src="' + task.message +'" type="audio/mpeg"></audio></div>'

        
      } else if(task.messageType === "video"){

         elem.innerHTML = '<span class="chat-img left clearfix mx-2"><img src="'+ task.profileImageUrl +'" alt="Admin" class="img-circle" style="width: 100%;"/></span><div class="chat-body clearfix"><div class="header clearfix"><small class="right text-muted"><span class="glyphicon glyphicon-time"></span>' + task.createdDate + '</small><strong class="primary-font" class="fullName">'+ task.userName +'</strong></div><video controls style="width:100%;"><source src="' + task.message +'" type="video/mp4"></video></div>'

        
      } else{

         elem.innerHTML = '<span class="chat-img left clearfix mx-2"><img src="'+ task.profileImageUrl +'" alt="Admin" class="img-circle" style="width: 100%;"/></span><div class="chat-body clearfix"><div class="header clearfix"><small class="right text-muted"><span class="glyphicon glyphicon-time"></span>' + task.createdDate + '</small><strong class="primary-font" class="fullName">'+ task.userName +'</strong></div><p class="message">' + task.message +'</p></div>'

        
      }

  }
  tasksDOM.append(elem);

  // if (task.status === "incomplete") {
  //   const updateBtn = document.createElement("button");
  //   updateBtn.setAttribute("class", "btn btn-success col-2 text-white mr-1");
  //   updateBtn.innerHTML =
  //     '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-check"><polyline points="20 6 9 17 4 12"></polyline></svg>';
  //   updateBtn.addEventListener("click", function () {
  //     return handleStatusUpdate(task);
  //   });
  //   elem.append(updateBtn);
  // }

  // const deleteBtn = document.createElement("button");
  // deleteBtn.setAttribute("class", "btn btn-danger col-2 text-white");
  // deleteBtn.innerHTML =
  //   '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-trash-2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>';
  // deleteBtn.addEventListener("click", function () {
  //   return handleDelete(task.id);
  // });
  // elem.append(deleteBtn);

  // tasksDOM.append(elem);
}


// Firebase functions
function fetchTasks() {

  // alert("fetch data");
  // return docRef
  //   .get()
  //   .then((snapshots) => cleanData(snapshots));
    // .then((tasks) => tasks.map((task) => createTask(task)));


     docRef.orderBy("createdDate", "asc").onSnapshot(function(snapshot) {
        snapshot.docChanges().forEach(function(change) {

         

            if (change.type === "added") {
                // console.log(task);
                
                // console.log("New city: ", change.doc.data().createdDate);

                var task = change.doc.data();

                var sData = localStorage.getItem('allTokenData');
                var storageData= JSON.parse(sData);
                var loggedInVal = storageData.uid;
                 var loggedInName = storageData.uname;
                // alert(loggedInName)
                const elem = document.createElement("li");
                elem.id = task.messageId;
                elem.innerHTML = reviewTemplate(task);
                tasksDOM.append(elem);

                 $('.card-body').scrollTop($('.card-body')[0].scrollHeight);

                // $('#tasks').scrollTop($('#tasks')[0].scrollHeight);
              //   elem.setAttribute("id", task.messageId);
              //   // elem.setAttribute("class", "admin clearfix");
              //   let taskElem;

              //   if (task.userId === loggedInVal) {

              //     // taskElem = document.createElement("li");
              //     elem.setAttribute("class", "admin clearfix");

              //       if(task.messageType === "photo"){

              //         elem.innerHTML = '<span class="chat-img right clearfix mx-2"><img src="'+ task.profileImageUrl +'" alt="Admin" class="img-circle" style="width: 100%;"/></span><div class="chat-body clearfix"><div class="header clearfix"><small class="left text-muted"><span class="glyphicon glyphicon-time"></span>' + task.createdDate + '</small><strong class="right primary-font" class="fullName">'+ task.userName +'</strong></div><p class="message"><img src="'+ task.message +'" class="img-responsive" style="width:100%;"/></p></div>'


              //       } else if(task.messageType === "audio"){

              //         elem.innerHTML = '<span class="chat-img right clearfix mx-2"><img src="'+ task.profileImageUrl +'" alt="Admin" class="img-circle" style="width: 100%;"/></span><div class="chat-body clearfix"><div class="header clearfix"><small class="left text-muted"><span class="glyphicon glyphicon-time"></span>' + task.createdDate + '</small><strong class="right primary-font" class="fullName">'+ task.userName +'</strong></div><audio controls><source src="' + task.message +'" type="audio/mpeg"></audio></div>'

              //       } else if(task.messageType === "video"){

              //         elem.innerHTML = '<span class="chat-img right clearfix mx-2"><img src="'+ task.profileImageUrl +'" alt="Admin" class="img-circle" style="width: 100%;"/></span><div class="chat-body clearfix"><div class="header clearfix"><small class="left text-muted"><span class="glyphicon glyphicon-time"></span>' + task.createdDate + '</small><strong class="right primary-font" class="fullName">'+ task.userName +'</strong></div><video controls style="width:100%;"><source src="' + task.message +'" type="video/mp4"></video></div>'

              //       } else {

              //         elem.innerHTML = '<span class="chat-img right clearfix mx-2"><img src="'+ task.profileImageUrl +'" alt="Admin" class="img-circle" style="width: 100%;"/></span><div class="chat-body clearfix"><div class="header clearfix"><small class="left text-muted"><span class="glyphicon glyphicon-time"></span>' + task.createdDate + '</small><strong class="right primary-font" class="fullName">'+ task.userName +'</strong></div><p class="message">' + task.message +'</p></div>'

              //       }

              //   } else {
              //     // taskElem = document.createElement("li");
              //     elem.setAttribute("class", "agent clearfix");

              //       if(task.messageType === "photo"){

              //           elem.innerHTML = '<span class="chat-img left clearfix mx-2"><img src="'+ task.profileImageUrl +'" alt="Admin" class="img-circle" style="width: 100%;"/></span><div class="chat-body clearfix"><div class="header clearfix"><small class="right text-muted"><span class="glyphicon glyphicon-time"></span>' + task.createdDate + '</small><strong class="primary-font" class="fullName">'+ task.userName +'</strong></div><p class="message"><img src="'+ task.message +'" class="img-responsive" style="width:100%;"/></p></div>'


              //       } else if(task.messageType === "audio"){

              //          elem.innerHTML = '<span class="chat-img left clearfix mx-2"><img src="'+ task.profileImageUrl +'" alt="Admin" class="img-circle" style="width: 100%;"/></span><div class="chat-body clearfix"><div class="header clearfix"><small class="right text-muted"><span class="glyphicon glyphicon-time"></span>' + task.createdDate + '</small><strong class="primary-font" class="fullName">'+ task.userName +'</strong></div><audio controls><source src="' + task.message +'" type="audio/mpeg"></audio></div>'

                      
              //       } else if(task.messageType === "video"){

              //          elem.innerHTML = '<span class="chat-img left clearfix mx-2"><img src="'+ task.profileImageUrl +'" alt="Admin" class="img-circle" style="width: 100%;"/></span><div class="chat-body clearfix"><div class="header clearfix"><small class="right text-muted"><span class="glyphicon glyphicon-time"></span>' + task.createdDate + '</small><strong class="primary-font" class="fullName">'+ task.userName +'</strong></div><video controls style="width:100%;"><source src="' + task.message +'" type="video/mp4"></video></div>'

                      
              //       } else{

              //          elem.innerHTML = '<span class="chat-img left clearfix mx-2"><img src="'+ task.profileImageUrl +'" alt="Admin" class="img-circle" style="width: 100%;"/></span><div class="chat-body clearfix"><div class="header clearfix"><small class="right text-muted"><span class="glyphicon glyphicon-time"></span>' + task.createdDate + '</small><strong class="primary-font" class="fullName">'+ task.userName +'</strong></div><p class="message">' + task.message +'</p></div>'

                      
              //       }

              //   }
               // elem.append(taskElem);

              // const deleteBtn = document.createElement("button");
              // deleteBtn.setAttribute("class", "btn btn-danger col-2 text-white");
              // deleteBtn.innerHTML =
              //   '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-trash-2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>';
              // deleteBtn.addEventListener("click", function () {
              //   return handleDelete(task.messageId);
              // });
              // elem.append(deleteBtn);

              // tasksDOM.append(elem);
            }
            if (change.type === "modified") {
                // console.log("Modified city: ", change.doc.data());
            }
            if (change.type === "removed") {
                // console.log("Removed city: ", change.doc.data());
            }

        });
    });


}

 fetchTasks();






// var reviewForm = document.getElementById('reviewForm');
// // var fullName   = document.getElementById('user_nickname');
// // var message    = document.getElementById('message');
// // var userId     = document.getElementById('user_id');
// // var hiddenId   = document.getElementById('hiddenId');
// // var date = document.getElementById('dateval');

// // reviewForm.addEventListener('submit', (e) => {
// //   e.preventDefault();

// //   if (!fullName.value || !message.value || !date.value) return null

// //   var id = hiddenId.value || Date.now()

// //   db.collection('/openGroups/demoOpenGroup1/messages/').add({
// //     userName: fullName.value,
// //     userId : userId.value,
// //     message: message.value,
// //     createdDate : date.value
// //   }).then(function(doc) {
// //         // console.log(docRef);
// //         // console.log("Document written with ID: ", docRef.id);

// //   var li = document.createElement('li')
// //   li.id = doc.id;
// //   li.innerHTML = reviewTemplate('<li class="admin clearfix"><span class="chat-img right clearfix mx-2"><img src="https://apis.tradetipsapp.com/api/appUser/getImageByAppUserId?appUserId=d9aced23-7b89-4abc-bd71-5523ab83a98a" alt="Admin" class="img-circle" style="width: 100%;"/></span><div class="chat-body clearfix"><div class="header clearfix"><small class="left text-muted"><span class="glyphicon glyphicon-time"></span>' + createdDate + '</small><strong class="right primary-font" class="fullName"> ' + userName + '</strong></div><p class="message"> ' + message + '</p></div></li>')
// //   reviews.appendChild(li);

// //     });

 

// //     fullName.value = '';
// //     message.value  = '';
// //     hiddenId.value = '';
// //     date.value = '';

// //   });

// // // READ REVEIWS



 

// // var reviews = document.getElementById('reviews');
// // var reviewsRef = db.ref("/reviews");
// // var reviewsRef = db.collection('openGroups').doc('demoOpenGroup1').collection('messages');
// // var reviewsRef = db.collection("/openGroups/demoOpenGroup1/messages").get().then((querySnapshot) => {
     
// //     // querySnapshot.forEach((doc) => {
// //         // alert(`${doc.id} => ${doc.data()}`);
// //          // sub_array.push(doc.data());

// //   // var li = document.createElement('li')
// //   // li.id = doc.id;
// //   // li.innerHTML = reviewTemplate(doc.data())
// //   // reviews.appendChild(li);
       
          
// //     // });

// //   });


// // var reviewsRef =

//  // db.collection("/openGroups/demoOpenGroup1/messages").get().then((querySnapshot) => {

//  //        var sub_array = [];
     
//  //    querySnapshot.forEach((doc) => {
//  //        // alert(`${doc.id} => ${doc.data()}`);
//  //         // sub_array.push(doc.data());
//  //    // alert(doc.id);
//  //  var li = document.createElement('li')
//  //  li.id = doc.id;
//  //  li.innerHTML = reviewTemplate(doc.data())
//  //  reviews.appendChild(li);
       
          
//  //    });

//  //  });

// // reviewsRef.on('child_added', (data) => {
// //   alert("add value" + data.val());
// //   var li = document.createElement('li')
// //   li.id = data.key;
// //   li.innerHTML = reviewTemplate(data.val())
// //   reviews.appendChild(li);
// // });


// // reviewsRef.on('child_changed', (data) => {
// //   alert("change" + data);
// //   var reviewNode = document.getElementById(data.key);
// //   reviewNode.innerHTML = reviewTemplate(data.val());
// // });

// // reviewsRef.on('child_removed', (data) => {
// //   alert("remove" + data);
// //   var reviewNode = document.getElementById(data.key);
// //   reviewNode.parentNode.removeChild(reviewNode);
// // });

// // reviews.addEventListener('click', (e) => {
// //   var reviewNode = e.target.parentNode

// //   // UPDATE REVEIW
// //   if (e.target.classList.contains('edit')) {
// //     fullName.value = reviewNode.querySelector('.fullName').innerText;
// //     message.value  = reviewNode.querySelector('.message').innerText;
// //     hiddenId.value = reviewNode.id;
// //   }

// //   // DELETE REVEIW
// //   if (e.target.classList.contains('delete')) {
// //     var id = reviewNode.id;
// //     db.ref('reviews/' + id).remove();
// //   }
// // });

function reviewTemplate({profileImageUrl,userName,userId, message,createdDate,messageType}) {

  // alert(profileImageUrl);
  // fetch(profileImageUrl, { method: 'HEAD' })
  //   .then(res => {
  //       if (res.ok) {
  //           alert('Image exists.');
  //       } else {
  //           alert('Image does not exist.');
  //       }
  //   }).catch(err => alert('Error:', err));
  var sData = localStorage.getItem('allTokenData');
  var storageData= JSON.parse(sData);
  var loggedInVal = storageData.uid;
  // alert(loggedInVal);
  // alert(userId);
  // var todate=new Date(createdDate).getDate();
  // var tomonth=new Date(createdDate).getMonth()+1;
  // var toyear=new Date(createdDate).getFullYear();
  // var original_date=tomonth+'/'+todate+'/'+toyear;
  // alert(original_date);

  const date = new Date(createdDate).toDateString();
  // alert(date);
   
   if(loggedInVal == userId){

        if(messageType == "text"){



           return `

            <li class="admin clearfix">
              <span class="chat-img right clearfix mx-2">
                  <img onerror="imgError(this);" src="${profileImageUrl}" alt="Admin" class="img-circle" style="width: 50px;height: 50px;"/>
              </span>
              <div class="chat-body clearfix">
                  <div class="header clearfix">
                      <small class="left text-muted"><span class="glyphicon glyphicon-time"></span>${date}</small>
                      <strong class="right primary-font" class='fullName'>${userName}</strong>
                  </div>
                  <p class='message'>
                      ${message}
                  </p>
              </div>
          </li>
          `

        }else if(messageType == "photo"){

           return `

            <li class="admin clearfix">
              <span class="chat-img right clearfix mx-2">
                  <img onerror="imgError(this);" src="${profileImageUrl}" alt="Admin" class="img-circle" style="width: 50px;height: 50px;"/>
              </span>
              <div class="chat-body clearfix">
                  <div class="header clearfix">
                      <small class="left text-muted"><span class="glyphicon glyphicon-time"></span>${date}</small>
                      <strong class="right primary-font" class='fullName'>${userName}</strong>
                  </div>
                    <p class='message'><img src="${message}" class="img-responsive" style="width:100%;"/></p>
              </div>
          </li>
          `

        }else if(messageType == "video"){

          return `

            <li class="admin clearfix">
              <span class="chat-img right clearfix mx-2">
                  <img onerror="imgError(this);" src="${profileImageUrl}" alt="Admin" class="img-circle" style="width: 50px;height: 50px;"/>
              </span>
              <div class="chat-body clearfix">
                  <div class="header clearfix">
                      <small class="left text-muted"><span class="glyphicon glyphicon-time"></span>${date}</small>
                      <strong class="right primary-font" class='fullName'>${userName}</strong>
                  </div>
                 <p class='message'><video controls style="width:100%;"><source src="${message}" type="video/mp4"></video></p>
              </div>
          </li>
          `
        } else {

          return `

            <li class="admin clearfix">
              <span class="chat-img right clearfix mx-2">
                  <img onerror="imgError(this);" src="${profileImageUrl}" alt="Admin" class="img-circle" style="width: 50px;height: 50px;"/>
              </span>
              <div class="chat-body clearfix">
                  <div class="header clearfix">
                      <small class="left text-muted"><span class="glyphicon glyphicon-time"></span>${date}</small>
                      <strong class="right primary-font" class='fullName'>${userName}</strong>
                  </div>
                <p class='message'><audio controls><source src="${message}" type="audio/mpeg"></audio></p>              </div>
          </li>
          `

        }

   }else{




     if(messageType == "text"){


         return `

        <li class="agent clearfix">
          <span class="chat-img left clearfix mx-2">
              <img onerror="imgError(this);" src="${profileImageUrl}" alt="Admin" class="img-circle" style="width: 50px;height: 50px;"/>
          </span>
          <div class="chat-body clearfix agent" style="float:none;background:#77839647;color:#000;">
              <div class="header clearfix">
                  <small class="right text-muted" style="color: #000 !important"><span class="glyphicon glyphicon-time"></span>${date}</small>
                  <strong class="primary-font" class='fullName' style="color: #000 !important">${userName}</strong>
              </div>
              <p class='message' style="color: #000 !important">
                  ${message}
              </p>
          </div>
      </li>
      `
     } else if(messageType == "video"){

         return `

        <li class="agent clearfix">
          <span class="chat-img left clearfix mx-2">
              <img onerror="imgError(this);" src="${profileImageUrl}" alt="Admin" class="img-circle" style="width: 50px;height: 50px;"/>
          </span>
          <div class="chat-body clearfix agent" style="float:none;background:#77839647;color:#000;">
              <div class="header clearfix">
                  <small class="right text-muted" style="color: #000 !important"><span class="glyphicon glyphicon-time"></span>${date}</small>
                  <strong class="primary-font" class='fullName' style="color: #000 !important">${userName}</strong>
              </div>
            
             <p class='message' style="color: #000 !important"><video controls style="width:100%;"><source src="${message}" type="video/mp4"></video></p>

          </div>
      </li>
      `
     }else if(messageType == "photo"){

         return `

        <li class="agent clearfix">
          <span class="chat-img left clearfix mx-2">
              <img onerror="imgError(this);" src="${profileImageUrl}" alt="Admin" class="img-circle" style="width: 50px;height: 50px;"/>
          </span>
          <div class="chat-body clearfix agent" style="float:none;background:#77839647;color:#000;">
              <div class="header clearfix">
                  <small class="right text-muted" style="color: #000 !important"><span class="glyphicon glyphicon-time"></span>${date}</small>
                  <strong class="primary-font" class='fullName' style="color: #000 !important">${userName}</strong>
              </div>
              <p class='message' style="color: #000 !important"><img src="${message}" class="img-responsive" style="width:100%;"/></p>

          </div>
      </li>
      `
     }else{

         return `

        <li class="agent clearfix">
          <span class="chat-img left clearfix mx-2">
              <img onerror="imgError(this);" src="${profileImageUrl}" alt="Admin" class="img-circle" style="width: 50px;height: 50px;"/>
          </span>
          <div class="chat-body clearfix agent" style="float:none;background:#77839647;color:#000;">
              <div class="header clearfix">
                  <small class="right text-muted" style="color: #000 !important"><span class="glyphicon glyphicon-time"></span>${date}</small>
                  <strong class="primary-font" class='fullName' style="color: #000 !important">${userName}</strong>
              </div>
              
              <p class='message' style="color: #000 !important"><audio controls><source src="${message}" type="audio/mpeg"></audio></p>             

          </div>
      </li>
      `
     }

   }

 
};

function imgError(image) {
    image.onerror = "";
    image.src = "images/userIcon.png";
    return true;
}
