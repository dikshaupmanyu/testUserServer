<%- include partials/innerheader %>

<style type="text/css">
  .successmsg {
    color: #fff;
    padding-left: 350px;
  }

  .successmsg3 {
    color: #fff;
    padding-left: 45px;
    padding-bottom: 30px;
    font-size: large;
  }

  .edit_profile_form {
    /* position:relative;
left:30%; */
    width: 100%;
  }

  .prfl_tb_cntnt_bx {
    margin: 0;
  }

  .secutityByStripe {
    padding-left: 30px;
    position: absolute;
    left: 100%;
    top: 12px;
  }

  .exp-wrapper {
    position: relative;
    /* border: 1px solid #aaa; */
    display: flex;
    /* width: 300px; */
    justify-content: space-around;
    height: 36px;
    line-height: 36px;
    font-size: 24px;
  }

  .exp-wrapper:after {
    content: "/";
    position: absolute;
    left: 50%;
    margin-left: -4px;
    color: #aaa;
  }

  input.exp {
    float: left;
    font-family: monospace;
    border: 0;
    width: 18px;
    outline: none;
    appearance: none;
    font-size: 14px;
  }

  .input-groups {
    display: flex;
  }
</style>

<div class="app_main">
  <%- include partials/innersidebar %>

  <div class="app_content">
    <div class="dsbrd_container">
      
        <div class="dsbrd_container" style="margin-left: 15px">
          <div class="dashboard_wrapper row">
            <form action="payment" method="POST" class="flex flex-col" style="width: 60%; position: relative"
              onSubmit="handleFormSubmit(this); return false;">
              <div class="post_new_tips_wrapper">
                <div class="edit_profile_form">
                  <div class="input-group">
                    <!-- <label>Card Number</label> -->
                    <input type="text" class="form-control" name="cardName" id="cardName" placeholder=" Full Name"
                      required="required" />
                    <!-- <span id="error" style="color: Red; display: none">* Input digits (0 - 9)</span>   -->
                  </div>
                  <div class="input-group">
                    <!-- <label>Card Number</label> -->
                    <input type="text" class="form-control" name="cardNumber" id="cardNumber" placeholder="Card Number"
                      onkeypress="return IsNumeric(event);" ondrop="return false;" onpaste="return false;"
                      required="required" />
                    <span id="error" style="color: Red; display: none">* Input digits (0 - 9)</span>
                  </div>
                  <div class="input-groups">
                    <div class="input-group">
                      <!-- example 1  start-->
                      <input maxlength="5" class="form-control" placeholder="Ex. Date  MM/YY" type="text"
                        onkeyup="formatString(event);" name="monthYear" style="margin-right: 10px" />
                      <!-- end -->
                    </div>

                    <div class="input-group">
                      <!--  <label>Cvv Number</label> -->
                      <input type="text" class="form-control" name="cvv" id="cvv" placeholder="CVV" required="required"
                        maxlength="3" onkeypress="return IsNumerics(event);" ondrop="return false;"
                        onpaste="return false;" />
                      <span id="errors" style="color: Red; display: none">* Input digits (0 - 9)</span>
                    </div>
                  </div>
                  <div class="input-group">
                    <!-- <label>Zip Code</label> -->
                    <input type="text" class="form-control" placeholder="Zip Code" required="required" maxlength="5"
                      onkeypress="return IsNumericpincode(event);" ondrop="return false;" onpaste="return false;"
                      style="max-width: 50%" />
                    <span id="errorpincode" style="color: Red; display: none">* Input digits (0 - 9)</span>
                  </div>

                  <spam style="color: #a3a3a3b8; margin-left: 15px">Have a Promo Code ?</spam>
                  <div class="input-group">
                    <input type="text" class="form-control" name="text1" id="couponadd" placeholder="Enter Promo Code"
                      style="margin-right: 10px" />
                    <!-- <span id="errorpincode" style="color: Red; display: none">* Input digits (0 - 9)</span> -->
                    <button class="btn cmn_btn btn_primary" type="button" id="stockadd"
                      onclick="validate(document.getElementsByName('text1')[0].value)">
                      Apply
                    </button>
                  </div>
                  <!-- <div class="app_header_content">
                              <div class="dsbrd_container"> -->
                  <div class="successmsg3"></div>
                  <!-- <span style="color: white;" id="priceService">&macr;</span> -->

                  <!-- </div>
                            </div> -->

                  <div class="input-groups">
                    <label class="hide-sm" style="
                          width: 40%;
                          padding-left: 15px;
                          font-size: large;
                          color: #aaa;
                        ">Total
                      <!-- <label class="hide-sm">Total</label> -->
                      <span style="color: white" id="priceServices"></span>
                    </label>
                    <div class="input-group">
                      <label class="hide-sm" style="width: 15%">
                        &nbsp;
                      </label>
                      <button class="btn cmn_btn btn_primary" type="submit">
                        Purchase
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <br />
              <br />
            </form>
          </div>
        </div>

  </div>
  </div>

<%- include partials/innerfooter %>


<script>
  function cc_format(value) {
    var v = value.replace(/\s+/g, "").replace(/[^0-9]/gi, "");
    var matches = v.match(/\d{4,16}/g);
    var match = (matches && matches[0]) || "";
    var parts = [];
    for (i = 0, len = match.length; i < len; i += 4) {
      parts.push(match.substring(i, i + 4));
    }
    if (parts.length) {
      return parts.join(" ");
    } else {
      return value;
    }
  }

  onload = function () {
    document.getElementById("cardNumber").oninput = function () {
      this.value = cc_format(this.value);
    };
  };

  var specialKeys = new Array();
  specialKeys.push(8);
  function IsNumeric(e) {
    var keyCode = e.which ? e.which : e.keyCode;
    var ret =
      (keyCode >= 48 && keyCode <= 57) || specialKeys.indexOf(keyCode) != -1;
    document.getElementById("error").style.display = ret ? "none" : "inline";
    return ret;
  }
  function IsNumerics(e) {
    var keyCode = e.which ? e.which : e.keyCode;
    var ret =
      (keyCode >= 48 && keyCode <= 57) || specialKeys.indexOf(keyCode) != -1;
    document.getElementById("errors").style.display = ret ? "none" : "inline";
    return ret;
  }
  function IsNumericpincode(e) {
    var keyCode = e.which ? e.which : e.keyCode;
    var ret =
      (keyCode >= 48 && keyCode <= 57) || specialKeys.indexOf(keyCode) != -1;
    document.getElementById("errorpincode").style.display = ret
      ? "none"
      : "inline";
    return ret;
  }
</script>

<script>
  function formatString(e) {
    var inputChar = String.fromCharCode(event.keyCode);
    var code = event.keyCode;
    var allowedKeys = [8];
    if (allowedKeys.indexOf(code) !== -1) {
      return;
    }

    event.target.value = event.target.value
      .replace(
        /^([1-9]\/|[2-9])$/g,
        "0$1/" // 3 > 03/
      )
      .replace(
        /^(0[1-9]|1[0-2])$/g,
        "$1/" // 11 > 11/
      )
      .replace(
        /^([0-1])([3-9])$/g,
        "0$1/$2" // 13 > 01/3
      )
      .replace(
        /^(0?[1-9]|1[0-2])([0-9]{2})$/g,
        "$1/$2" // 141 > 01/41
      )
      .replace(
        /^([0]+)\/|[0]+$/g,
        "0" // 0/ > 0 and 00 > 0
      )
      .replace(
        /[^\d\/]|^[\/]*$/g,
        "" // To allow only digits and `/`
      )
      .replace(
        /\/\//g,
        "/" // Prevent entering more than 1 `/`
      );
  }
</script>

<script type="text/javascript">
  window.history.forward();
  function noBack() {
    window.history.forward();
  }

  //     function test()
  //        {
  //            var selectedValue = document.getElementById("userFull").value;
  //            // alert(selectedValue);
  //            document.getElementById("amountSubscription").value = selectedValue;

  //            var e = document.getElementById("userFull");
  //            var ns = e.options[e.selectedIndex].id;

  //            // alert(textns);

  //            document.getElementById("planId").value = ns;

  //            var dataans = e.options[e.selectedIndex].text;

  //            document.getElementById("planName").value = dataans;

  //            // alert(ns);
  //        }
  //        test();

  //  var sData = localStorage.getItem('allTokenData');
  //   var storageData= JSON.parse(sData);

  //   var tokens = storageData.tokendata;
  //   //alert(tokens);

  //  var userName = storageData.uname;
  // // alert(userName);
  //   document.getElementById("names").value = userName;

  //   var emails = storageData.email;
  //  //alert(emails);
  //  document.getElementById("emails").value = emails;

  //  document.getElementById("tokensdata").value = tokens;

  //  var requestOptions = {
  //    method: 'POST',
  //    headers: {
  //          Authorization: 'Bearer '+ tokens,
  //        },
  //    redirect: 'follow'
  //  };

  //  fetch("https://apistest.tradetipsapp.com/api/subscriptionPlan/getAllNewSubscriptionPlan", requestOptions)
  //  .then(resp => resp.json())
  //    .then(function(data) {
  //      // console.log(data);
  //      for( var i = 0; i< data.length; i++){
  //          var userid = data[i]['id'];
  //          var subscriptionType = data[i]['subscriptionType'];
  //          var subscriptionPrice = data[i]['subscriptionPrice'];
  //          $("#userFull").append("<option value='"+subscriptionPrice+"' id='"+userid+"'>"+subscriptionType+"</option>");
  //          $("#newplanprice").append("<th scope='col'>$<span style='font-size: 30px;'>"+subscriptionPrice+"</span></th>");
  //          $("#newplantype").append("<td>"+subscriptionType+"</td>");
  //                // $("#newplan").append("<thead><tr><td scope='col'>$<span style='font-size: 30px;''>"+subscriptionPrice+"</span></td></tr></thead><tbody><tr><td scope='row'>"+subscriptionType+"</td></tr></tbody>");
  //           // var e = document.getElementById("userFull");
  //           // var ids=e.selectElement.options[e.selectedIndex].id;
  //           // alert(ids);
  //          // var text=e.options[e.selectedIndex].text;//get the selected option text
  //          }
  //  });

  var count = 0;

  function validate(coupon) {
    // count++;
    // if (count == 1) {



    var formdata = { couponId: coupon };

    $.ajax({
      type: "POST",
      url: "https://apis.tradetipsapp.com/api/stripePayment/validateCoupon",
      data: formdata,
      success: function (data, textStatus, jqXHR) {
        // alert(data.percent_off);
        console.log(data);

        // console.log(data.percent_off);
        var finalpvals = data.percent_off;
        //  alert(finalpvals);
        var pricess = $("#prices").val();
        //  var pricess = ActualP.val();

        //  alert(pricess);
        var fdiscount = (pricess * finalpvals) / 100;
        //  alert(fdiscount);

        if (data.valid == true) {
          count++;
          if (count == 1) {
            var Damount = pricess - fdiscount;
            // alert(Damount)
            document.getElementById("prices").value = fdiscount;

            $(".successmsg3").html(
              `<span style='padding-left:11px'>${"$" + pricess / 100}</span>` +
              "<br>" +
              "-" +
              "    " +
              `<span>${"$" + (fdiscount / 100).toString().match(/^-?\d+(?:\.\d{0,2})?/)[0]} </span>` +
              "<span style='width:5px'>&nbsp; </span>" +
              " Discount applied. Please continue your purchase."
            );
            setTimeout(function () {
              $(".successmsg3").empty();
            }, 1200000);

            document.getElementById("priceServices").innerHTML = parseFloat(
              Damount / 100
            ).toFixed(2);
          } else {
            $(".successmsg3").html(
              "Sorry, You can apply coupan code only once"
            );
            setTimeout(function () {
              $(".successmsg3").empty();
            }, 3000);
          }
        }
      },
      error: function (errMsg) {
        // alert(JSON.stringify(errMsg));
        //  window.alert("Sorry, The Coupon Code you entered is invalid. Please check and try again!");
        $(".successmsg3").html(
          "Sorry, The Coupon Code you entered is invalid. Please check and try again!"
        );
        setTimeout(function () {
          $(".successmsg3").empty();
        }, 3000);
      },
    });
    // } else {
    //   $(".successmsg3").html(
    //     "Sorry, You can apply coupan code only once"
    //   );
    //   setTimeout(function () {
    //     $(".successmsg3").empty();
    //   }, 3000);
    // }
  }
</script>